<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chunked File Upload</title>
</head>
<body>

    <h2>행햟햡혞향햨햟 혟햟햧햩햟  혢햟혜혝혪햪</h2>
    <input type="file" id="fileInput" />
    <button onclick="startUpload()">행햟햡혞향햦혝혧</button>
    <p id="status"></p>
    <p id="fileUuid"></p>

    <script>
        const CHUNK_SIZE = 5 * 1024 * 1024; // 5 햎햄
        const hostUrl = 'http://localhost:5106'
        async function startUpload() {
            const fileInput = document.getElementById("fileInput");
            const fileUuidLabel = document.getElementById("fileUuid")
            if (!fileInput.files.length) {
                alert("뉌햠햣햦혝햣 혟햟햧햩!")
                return;
            }
            const file = fileInput.files[0]
            document.getElementById("status").innerText = "햊햫햦혡햦햟햩햦향햟혡햦혪 향햟햡혞향햨햦..."
            
            try {
                // 1. 햊햫햦혡햦햟햩햦향햦혞햣햪 향햟햡혞향햨혞 햦 쮏혞혢햟햣햪 fileUuid
                if (file.size < CHUNK_SIZE) {
                    const fileResponse = await uploadFile(file)
                    if (!fileResponse) throw new Error("햏햣 혞햢햟햩쮐혧 쮏혞혢햦혝혧 fileUuid")
                    fileUuidLabel.textContent = fileResponse.fileUuid
                }
                else {
                    const fileResponse = await initializeUpload(file)
                    if (!fileResponse) throw new Error("햏햣 혞햢햟햩쮐혧 쮏혞혢햦혝혧 fileUuid")
                    console.log(fileResponse)
                    
                    document.getElementById("status").innerText = "행햟햡혞향햨햟 혢햟햫햨쮏..."

                    // 2. 행햟햡혞햤햟햣햪 혟햟햧햩  혢햟혜혝혪햪
                    const etags = await uploadChunks(file, fileResponse.fileUuid);

                    // 3. 행햟쒫왐혣햟햣햪 향햟햡혞향햨혞
                    await completeUpload(fileResponse.fileUuid, etags)
                    fileUuidLabel.textContent = fileResponse.fileUuid
                }
                document.getElementById("status").innerText = "햓햟햧햩 혞혜햣혣햫 향햟햡혞햤햣햫!"
            } catch (error) {
                console.error("뤰걣쟳쐃쥃 향햟햡혞향햨햦:", error)
                document.getElementById("status").innerText = "뤰걣쟳쐃쥃 향햟햡혞향햨햦!"
            }
        }

        // 游댳 1. 햊햫햦혡햦햟햩햦향햟혡햦혪 향햟햡혞향햨햦
        async function initializeUpload(file) {
            const filename = encodeURIComponent(file.name)
            console.log(filename)
            const response = await fetch(`${hostUrl}/fileStorage/initialize?fileName=${filename}&containerName=test`, {
                method: "POST"
            });
            const result = await response.json();
            return result; // 쮏혞혢햟햣햪 fileUuid
        }

        // 游댳 2. 행햟햡혞향햨햟 혢햟햫햨쮏
        async function uploadChunks(file, fileUuid) {
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            const etags = []
            for (let i = 0; i < totalChunks; i++) {
                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);

                const result = await uploadChunk(chunk, fileUuid, i + 1);
                etags.push(result);

                document.getElementById("status").innerText = `행햟햡혞햤햣햫 ${i + 1} 햦향 ${totalChunks} 혢햟혜혝햣햧...`;
            }
            return etags
        }
        async function uploadFile(file) {
            const filename = encodeURIComponent(file.name)
            console.log(filename)
            const response = await fetch(`${hostUrl}/fileStorage/uploadFile?fileName=${filename}&containerName=test`, {
                method: "POST",
                body: file
            });
            const result = await response.json()
            return result
        }
        // 游댳 2.1. 행햟햡혞향햨햟 쮏얧쫧쮏 혢햟햫햨햟
        async function uploadChunk(chunk, fileUuid, partNumber) {
            const response = await fetch(`${hostUrl}/fileStorage/uploadPart?fileUuid=${fileUuid}&partNumber=${partNumber}`, {
                method: "POST",
                body: chunk
            });
            const result = await response.json();
            return result;
        }
        // 游댳 3. 행햟쒫왐혣햣햫햦햣 향햟햡혞향햨햦
        async function completeUpload(fileUuid, etags) {
            await fetch(`${hostUrl}/fileStorage/complete`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    fileUuid, 
                    parts: etags
                })
            });
        }
    </script>

</body>
</html>
